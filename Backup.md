Бэкап - резервное копирование данных для переноса и восстановления.

По дефолту андроид сохраняет пермишны которые были выданы приложению и восстановит их при переносе данных(начиная с `API 24(Android 7)`).

Если пользак отключает бэкап в настройках - `Android Backup Service` удаляет все сохраненные бэкапы.

# Что нужно сохранять
1. Все настройки пользователя
2. Включал или отключал пользак уведомления и звуковые оповещения
3. Флаги(например видел ли пользак welcome экран или нет)

> Не стоит сохранять `URI` - они могут быть нестабильными

# Опции бэкапа
1. *Автоматический бэкап*: сохраняет данные выгружая их на `Google Drive` пользака. Включает файлы большинства папок которые связаны с твоим приложением. Может хранить до 25 МБ для каждого приложения. Можно использовать `XML` чтобы добавлять и исключать файлы. Авто бэкап выполняется примерно один раз в день.
2. *Бэкап `key-value`*: сохраняет настройки парами `key-value` выгружая их в `Android Backpu Service`. Нужно реализовать `BackupAgent`. Приложения должны кидать *запрос* на сохранение данных для резевного копирования. Запросы от приложений группируются и выполняются каждые *несколько часов*. Размер ограничен 5 МБ.

> ***Приложение может реализовать автоматический бэкап или `key-value` бэкап, но не оба одновременно!

Рекомендуется `Auto Backup` потому что он включен по дефолту и не требует ничего реализовывать. Для приложений, которые у которых таргет `API 23(Android 6)` он включен по умолчанию.

> Чтобы осуществить бэкап у пользака должен быть осуществлен вход в **Google Account**

> Пользак может выключить передачу данных по wifi по дефолту и не подключаться к wifi. В таком случае если пользак не изменит настройки бэкапа автоматический бэкап может никогда не произойти

# Автоматический бэкап
Начиная с `API 28(Android 9)` авто бэкапы `encrypted`.

По дефолту авто бэкап включает файлы из большинства папок которые привязаны к приложению:
3. `shared preferences`
4. файлы из `internal` хранилища которые были сохранены через `getFilesDir()`/`getDir(String, Int)`
5. файлы из папки которую возвращает `getDatabasePath(String)`. Также включает файлы созданные через класс `SQLiteOpenHelper`
6. файлы в `external` хранилище которое возвращает `getExternalFilesDir(String)`

> Авто бэкап исключает файлы в папках `getCacheDir()`, `getCodeCacheDir` и `getNoBackupFilesDir()`

> Бэкап ***не сохраняет данные*** приложения если превышен размер бэкапа приложения(25 МБ)

* Бэкап сохраняется в `Google Drive` пользователя, однако сохраненные данные не учитываются в рамках ограничения размера диска пользака.
* Хранится только самый свежий бэкап.
* Пользак может посмотреть список приложений для которых сработал бэкап в приложении `Google Drive` на устройстве.

Восстановление происходит когда приложение установлено, но перед тем как оно станет доступно для запуска пользователю.

## Включение и отключение бэкапа
Прилы у которых таргет `API 23(Android 6)` или выше автоматически имеют включенный авто бэкап. Но в манифесте можно проставить `android:allowBackup` чтобы включить или отключить бэкап. Рекомендуется *самостоятельно* выставить это значение.

## Добавление и исключение файлов
Если таргет на `API 31(Android 12)` - нужно *обязательно* выставить `XML` с правилами бэкапа через `android:dataExtractionRules="xmlFile`.

## Настройка бэкапа на Android 11(30 API)
В манифесте нужно прописать `fullBackupContent="@xml/file"`, создать `XML` файлик с правилами.
В этом файлике можно также задать два свойства:
* `clientSideEncryption` - включено с `API 28(Android 9)` если пользователь имеет `screen lock`(пароль). Пользовательские данные не включаются в бэкап до тех пор, пока у клиента не будет включено шифрование
* `deviceToDeviceTransfer` - ахуенное объяснение от гугла. Ничего не понятно

> Если обновляешь андроид до 9 - надо отключить и затем включить бэкап после обновления - андроид шифрует бэкапы со стороны клиента(КАК БЛЯТЬ ОН ШИФРУЕТ СО СТОРОНЫ КЛИЕНТА?) после того как пользователь будет уведомлен в настройках или при установке андроида

Также при реализации `key-value` бэкапа или `BackupAgent`'а можно применить эти требования через побитовое сравнение между `BackupDataOutput.transportFlags` и `FLAG_CLIENT_SIDE_ENCRYPTION_ENABLED` & `FLAG_CLIENT_SIDE_ENCRYPTION_ENABLED` флагами.

[Настройка на 11 Андроиде](https://developer.android.com/identity/data/autobackup#include-exclude-android-11)

## Настройка бэкапа на Android 12(31 API)
В манифесте нужно прописать `dataExtractionRules="xmlFile"`, создать `XML` файлик с правилами.
***Файлы по структуре отличаются между 11 & 12 Android - переиспользовать нельзя***.

[Настройка на 12 Андроиде](https://developer.android.com/identity/data/autobackup#include-exclude-android-12)

# Backup Transport
Бэкап Транспорт - компоненты андроида, которые ответственны за хранение и получение данных приложений. У девайса может быть 0 или более бэкап транспортов, но только один из них может быть помечен как активный.
Доступный бэкап транспорт отличается от девайса к девайсу из-за *вендоров* и сервис провайдеров, но большинство устройств с включенным Google Play'ем имеют следующие траснпорты:
* GMS Transport - активный облачный бэкап транспорт на большинстве девайсов(часть `Google Mobile Services`). Транспорт хранит данные в `Android Backup Service`
* D2D Transport - транспорт используемый в `D2D` миграциях чтобы напрямую перенести данные с одного устройства на другое

# `key-value` бэкап
`Android Backup Service` предоставляет облачное хранилище. Во время `key-value` бэкапа, бэкап приложения проходит в бэкап транспорт девайса

> Бэкап транспорт, предоставленный из `Android Backup Service`, не гарантирует доступность на всех андроид устройствах, что поддерживают бэкап. Некоторые устройства могут поддерживать бэкап через отличающийся транспорт, некоторые устройства могут не поддерживать бэкап в целом и здесь нет возможности для приложения узнать какой транспорт используется на устройстве

## Реализация `key-value` бэкапа
Нужно реализовать свой бэкап агент. Бэкап агент вызывается `Backup Manager`'ом для обоих действий - бэкапа и восстановления.

Для реализации надо:
* в манифесте указать бэкап агент - `android:backupAgent` и [добавить](https://developer.android.com/identity/data/keyvaluebackup#BackupManifest) в мета-данные `API` ключ. Сейчас `Android Backup Service` не требует ключ, но он может использоваться на старых девайсах
* Реализовать бэкап агент используя один из следующих путей:
	* Расширить `BackupAgent` - этот класс предоставляет общий интерфейс для приложения чтобы взаимодействовать с `Backup Manager`'ом. [Дока](https://developer.android.com/identity/data/keyvaluebackup#BackupAgent), [Реализация full backup](https://github.com/sukawasatoru/study-android-backupagent/blob/master/app/src/main/kotlin/com/example/study/backupagent/AppBackupAgent.kt)
	* Расширить `BackupAgentHelper` - класс предоставляет обертку над `BackupAgent`'ом минимизируя количество кода, которое нужно будет написать. В бэкап хелпере нужно использовать один или более хелпер для того чтобы автоматически бэкапить и восстанавливать определенные типы данных. Не нужно реализовывать `onBackup()` и `onRestore()`. [Реализация](https://developer.android.com/identity/data/keyvaluebackup#BackupAgentHelper)

> Андроид предоставляет бэкап хелперы, которые помогают полностью бэкапить и восстанавливать файлы из `SharedPreferences` и `internal` хранилища.

Атрибут `android:restoreAnyVersion` принимает `Boolean`, который говорит можно ли восстанавливать дынные приложения независимо от текущей версии по сравнению с версией которая создала бэкап. По умолчанию `false`.

## Проверка версии данных при восстановлении
Когда бэкап менеджер сохраняет данные в облачное хранилище он автоматом включает версию приложения объявленное в манифесте `android:versionCode` атрибут. Перед тем как бэкап менеджер вызовет бэкап агент для восстановления данных он смотрит на версию установленного приложения и сравнивает со значением в данных для восстановления.
Если записанная версия новее, чем приложение на устройстве - пользователь понизил версию приложения и бэкап менеджер прервет восстановление и не вызовет `onRestore`. Можно переопределить это поведение через `restoreAnyVersion`
При переопределении можно самостоятельно проверять версию в методе `onRestore` - из данных можно забрать `appVersionCode`. [Пример](https://developer.android.com/identity/data/keyvaluebackup#RestoreVersion)

## Запрос бэкапа и восстановления
Можно запросить бэкап в любое время вызвав `dataChanged()`. Этот метод уведомит бэкап менеджер что нужно бэкапнуть данные используя бэкап агент. Бэкап менеджер в будущем вызовет `onBackup` метод. Если вызвать `dataChanged` несколько раз перед тем как бэкап менеджер запросит бэкап из бэкап агента, у агента `onBackup()` будет вызван лишь один раз.

Для восстановления не нужно вызывать восстановление самостоятельно - система автоматически проверяет бэкап и восстанавливает данные после установки приложения.

> Можно моментально инициировать бэкап и восстановление через `bmgr` tool - `shell tool`

## Миграция на авто бэкап
Можно использовать атрибут `android:fullBackupOnly` чтобы система сделала автоматический бэкап вместо `key-value` бэкапа.
Если прила ориентирована на `API 22(Android 5.1)` и ниже - это свойство будет игнорироваться.

# Тестирование бэкапов и восстановления
Рекомендуется тестить оба варианта(облачное и с устройства на устройство) каждый мажорный релиз.

С `API 31(Android 12)` передача с устройства на устройство ограничена 2 ГБ, а облачный бэкап - 25 МБ.

> Во время `D2D` переноса бэкап менеджер сервис ставит прилу для бэкапа в очередь и отправляет данные напрямую в бэкап менеджер сервис другого устройства.

* [Тестирование облачного бэкапа](https://developer.android.com/identity/data/testingbackup#TestingBackup)
* [Тестирование D2D передачи](https://developer.android.com/identity/data/testingbackup#TestingTransfer)

# Вопросы и практика
1. Что делать с `EncryptedSharedPreferences` при бэкапе? [Ресурс](https://stackoverflow.com/questions/61751264/autobackup-with-encryptedsharedpreferences-failing-to-restore)
		Есть один интересный способ, который не бьет по безопасности: спросить у пользователя пароль который использовать как ключ для шифрованных шаредов и сохранить его в `EncryptedSharedPreferences` с обычным ключом, зашитым в девайсе. При восстановлении попросить пользака ввести пароль и получить доступ ко всем шаредам!(Ну и сохранить этот пароль, но уже для нового девайса с его зашитым ключом)
2. Что будет если забыть эксклюднуть `EncryptedSharedPreferences` и он будет включен в бэкап?(при бэкапе скорее всего ничего, а вот при восстановлении?)
3. Как-то можно эксклюднуть конкретный шаред преф используя авто бэкап?